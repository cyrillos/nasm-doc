\chapter{The NASM \textindexlc{Preprocessor}}
\label{ch:preproc}

NASM contains a powerful \textindex{macro processor}, which supports
conditional assembly, multi-level file inclusion, two forms of macro
(single-line and multi-line), and a ``context stack'' mechanism for
extra macro power. Preprocessor directives all begin with a \code{\%}
sign.

The preprocessor collapses all lines which end with a backslash
\code{\textbackslash} character into a single line.
Thus:

\begin{lstlisting}
%define THIS_VERY_LONG_MACRO_NAME_IS_DEFINED_TO \
        THIS_VALUE
\end{lstlisting}

will work like a single-line macro without the backslash-newline
sequence.

\section{\textindexlc{Single-Line Macros}}
\label{sec:slmacro}

\subsection{The Normal Way: \indexcode{\%idefine}\codeindex{\%define}}
\label{subsec:define}

Single-line macros are defined using the \code{\%define} preprocessor
directive. The definitions work in a similar way to C; so you can do
things like

\begin{lstlisting}
%define ctrl    0x1F &
%define param(a,b) ((a)+(a)*(b))

        mov     byte [param(2,ebx)], ctrl 'D'
\end{lstlisting}

which will expand to

\begin{lstlisting}
        mov     byte [(2)+(2)*(ebx)], 0x1F & 'D'
\end{lstlisting}

When the expansion of a single-line macro contains tokens which
invoke another macro, the expansion is performed at invocation time,
not at definition time. Thus the code

\begin{lstlisting}
%define a(x)    1+b(x)
%define b(x)    2*x

        mov     ax,a(8)
\end{lstlisting}

will evaluate in the expected way to \code{mov ax,1+2*8}, even though
the macro \code{b} wasn't defined at the time of definition of \code{a}.

Macros defined with \code{\%define} are \textindex{case sensitive}: after
\code{\%define foo bar}, only \code{foo} will expand to \code{bar}:
\code{Foo} or \code{FOO} will not. By using \code{\%idefine} instead of
\code{\%define} (the ``i'' stands for ``insensitive'') you can define
all the case variants of a macro at once, so that \code{\%idefine foo bar}
would cause \code{foo}, \code{Foo}, \code{FOO}, \code{fOO} and so on
all to expand to \code{bar}.

There is a mechanism which detects when a macro call has occurred as
a result of a previous expansion of the same macro, to guard against
\textindex{circular references} and infinite loops. If this happens,
the preprocessor will only expand the first occurrence of the macro.
Hence, if you code

\begin{lstlisting}
%define a(x)    1+a(x)

        mov     ax,a(3)
\end{lstlisting}

the macro \code{a(3)} will expand once, becoming \code{1+a(3)}, and will
then expand no further. This behaviour can be useful: see \fullref{sec:32c}
for an example of its use.

You can \index{overloading, single-line macros}overload single-line
macros: if you write

\begin{lstlisting}
%define foo(x)   1+x
%define foo(x,y) 1+x*y
\end{lstlisting}

the preprocessor will be able to handle both types of macro call,
by counting the parameters you pass; so \code{foo(3)} will become
\code{1+3} whereas \code{foo(ebx,2)} will become \code{1+ebx*2}.
However, if you define

\begin{lstlisting}
%define foo bar
\end{lstlisting}

then no other definition of \code{foo} will be accepted: a macro with
no parameters prohibits the definition of the same name as a macro
\emph{with} parameters, and vice versa.

This doesn't prevent single-line macros being \emph{redefined}:
you can perfectly well define a macro with

\begin{lstlisting}
%define foo bar
\end{lstlisting}

and then re-define it later in the same source file with

\begin{lstlisting}
%define foo baz
\end{lstlisting}

Then everywhere the macro \code{foo} is invoked, it will be expanded
according to the most recent definition. This is particularly useful
when defining single-line macros with \code{\%assign}
(see \fullref{sec:assign}).

You can \textindex{pre-define} single-line macros using the \code{-d}
option on the NASM command line: see \fullref{subsec:opt-d}.

\subsection{Resolving \code{\%define}: \indexcode{\%ixdefine}\codeindex{\%xdefine}}
\label{subsec:xdefine}

To have a reference to an embedded single-line macro resolved at the
time that the embedding macro is \emph{defined}, as opposed to when the
embedding macro is \emph{expanded}, you need a different mechanism to the
one offered by \code{\%define}. The solution is to use \code{\%xdefine}, or
it's \index{case sensitive}case-insensitive counterpart \code{\%ixdefine}.

Suppose you have the following code:

\begin{lstlisting}
%define  isTrue  1
%define  isFalse isTrue
%define  isTrue  0

val1:    db      isFalse

%define  isTrue  1

val2:    db      isFalse
\end{lstlisting}

In this case, \code{val1} is equal to 0, and \code{val2} is equal to 1.
This is because, when a single-line macro is defined using \code{\%define},
it is expanded only when it is called. As \code{isFalse} expands to \code{isTrue},
the expansion will be the current value of \code{isTrue}. The first time it is called
that is 0, and the second time it is 1.

If you wanted \code{isFalse} to expand to the value assigned to the
embedded macro \code{isTrue} at the time that \code{isFalse} was defined,
you need to change the above code to use \code{\%xdefine}.

\begin{lstlisting}
%xdefine isTrue  1
%xdefine isFalse isTrue
%xdefine isTrue  0

val1:    db      isFalse

%xdefine isTrue  1

val2:    db      isFalse
\end{lstlisting}

Now, each time that \code{isFalse} is called, it expands to 1,
as that is what the embedded macro \code{isTrue} expanded to at
the time that \code{isFalse} was defined.

% FIXME the keys
\subsection{\textindexlc{Macro Indirection}: \indexcode{\%[}\code{\%[...]}}
\label{subsec:indmacro}

The \code{\%[...]} construct can be used to expand macros in contexts
where macro expansion would otherwise not occur, including in the
names other macros. For example, if you have a set of macros named
\code{Foo16}, \code{Foo32} and \code{Foo64}, you could write:

\begin{lstlisting}
mov ax,Foo%[__BITS__]	; The Foo value
\end{lstlisting}

to use the builtin macro \code{\_\_BITS\_\_} (see \fullref{sec:bitsm})
to automatically select between them. Similarly, the two statements:

\begin{lstlisting}
%xdefine Bar		Quux	; Expands due to %xdefine
%define  Bar		%[Quux]	; Expands due to %[...]
\end{lstlisting}

have, in fact, exactly the same effect.

\code{\%[...]} concatenates to adjacent tokens in the same way that
multi-line macro parameters do, see \fullref{sec:concat} for details.

% FIXME concatmacro key
\subsection{Concatenating Single Line Macro Tokens: \codeindex{\%+}}
\label{subsec:concatmacro}

Individual tokens in single line macros can be concatenated, to produce
longer tokens for later processing. This can be useful if there are
several similar macros that perform similar functions.

Please note that a space is required after \code{\%+}, in order to
disambiguate it from the syntax \code{\%+1} used in multiline macros.

As an example, consider the following:

\begin{lstlisting}
%define BDASTART 400h                ; Start of BIOS data area

struc   tBIOSDA                      ; its structure
        .COM1addr       RESW    1
        .COM2addr       RESW    1
        ; ..and so on
endstruc
\end{lstlisting}

Now, if we need to access the elements of tBIOSDA in different places,
we can end up with:

\begin{lstlisting}
mov     ax,BDASTART + tBIOSDA.COM1addr
mov     bx,BDASTART + tBIOSDA.COM2addr
\end{lstlisting}

This will become pretty ugly (and tedious) if used in many places, and
can be reduced in size significantly by using the following macro:

\begin{lstlisting}
; Macro to access BIOS variables by their names (from tBDA):

%define BDA(x)  BDASTART + tBIOSDA. %+ x
\end{lstlisting}

Now the above code can be written as:

\begin{lstlisting}
mov     ax,BDA(COM1addr)
mov     bx,BDA(COM2addr)
\end{lstlisting}

Using this feature, we can simplify references to a lot of macros
(and, in turn, reduce typing errors).

% FIXME they key
\subsection{The Macro Name Itself: \codeindex{\%?} and \codeindex{\%??}}
\label{subsec:selfref}

The special symbols \code{\%?} and \code{\%??} can be used to
reference the macro name itself inside a macro expansion,
this is supported for both single-and multi-line macros.
\code{\%?} refers to the macro name as \emph{invoked}, whereas
\code{\%??} refers to the macro name as \emph{declared}.
The two are always the same for case-sensitive macros, but
for case-insensitive macros, they can differ.

For example:

\begin{lstlisting}
%idefine Foo mov %?,%??

        foo
        FOO
\end{lstlisting}

will expand to:

\begin{lstlisting}
        mov foo,Foo
        mov FOO,Foo
\end{lstlisting}

The sequence:

\begin{lstlisting}
%idefine keyword $%?
\end{lstlisting}

can be used to make a keyword ``disappear'', for example in case a new
instruction has been used as a label in older code.  For example:

\begin{lstlisting}
%idefine pause $%?		; Hide the PAUSE instruction
\end{lstlisting}

\subsection{Undefining Single-Line Macros: \codeindex{\%undef}}
\label{subsec:undef}

Single-line macros can be removed with the \code{\%undef} directive.
For example, the following sequence:

\begin{lstlisting}
%define foo bar
%undef  foo

        mov     eax, foo
\end{lstlisting}

will expand to the instruction \code{mov eax, foo}, since after
\code{\%undef} the macro \code{foo} is no longer defined.

Macros that would otherwise be pre-defined can be undefined on the
command-line using the \code{-u} option on the NASM command line:
see \fullref{subsec:opt-u}.

\subsection{\textindex{Preprocessor Variables}: \codeindex{\%assign}}
\label{subsec:assign}

An alternative way to define single-line macros is by means of the
\code{\%assign} command (and its \index{case sensitive}case-insensitive
counterpart \codeindex{\%iassign}, which differs from \code{\%assign} in
exactly the same way that \code{\%idefine} differs from \code{\%define}).

\code{\%assign} is used to define single-line macros which take no
parameters and have a numeric value. This value can be specified in
the form of an expression, and it will be evaluated once, when the
\code{\%assign} directive is processed.

Like \code{\%define}, macros defined using \code{\%assign} can be
re-defined later, so you can do things like

\begin{lstlisting}
%assign i i+1
\end{lstlisting}

to increment the numeric value of a macro.

\code{\%assign} is useful for controlling the termination of \code{\%rep}
preprocessor loops: see \fullref{subsec:rep} for an example of this. Another
use for \code{\%assign} is given in \fullref{subsec:16c} and
\fullref{subse:32c}.

The expression passed to \code{\%assign} is a \textindex{critical expression}
(see \fullref{sec:crit}), and must also evaluate to a pure number
(rather than a relocatable reference such as a code or data address,
or anything involving a register).

\subsection{Defining Strings: \indexcode{\%idefstr}\codeindex{\%defstr}}
\label{subsec:defstr}

\code{\%defstr}, and its case-insensitive counterpart \code{\%idefstr},
define or redefine a single-line macro without parameters but converts
the entire right-hand side, after macro expansion, to a quoted string
before definition.

For example:

\begin{lstlisting}
%defstr test TEST
\end{lstlisting}

is equivalent to

\begin{lstlisting}
%define test 'TEST'
\end{lstlisting}

This can be used, for example, with the \code{\%!} construct
(see \fullref{subsec:getenv}):

\begin{lstlisting}
%defstr PATH %!PATH          ; The operating system PATH variable
\end{lstlisting}

\subsection{Defining Tokens: \indexcode{\%ideftok}\codeindex{\%deftok}}
\label{subsec:deftok}

\code{\%deftok}, and its case-insensitive counterpart \code{\%ideftok},
define or redefine a single-line macro without parameters but converts
the second parameter, after string conversion, to a sequence of tokens.

For example:

\begin{lstlisting}
%deftok test 'TEST'
\end{lstlisting}

is equivalent to

\begin{lstlisting}
%define test TEST
\end{lstlisting}

\section{\textindexlc{String Manipulation in Macros}}
\label{sec:strlen}

It's often useful to be able to handle strings in macros. NASM
supports a few simple string handling macro operators from which
more complex operations can be constructed.

All the string operators define or redefine a value (either a string
or a numeric value) to a single-line macro. When producing a string
value, it may change the style of quoting of the input string or
strings, and possibly use \code{\textbackslash}-escapes inside
\code{`}-quoted strings.

\subsection{\textindexlc{Concatenating Strings}: \codeindex{\%strcat}}
\label{subsec:strcat}

The \code{\%strcat} operator concatenates quoted strings and assign
them to a single-line macro.

For example:

\begin{lstlisting}
%strcat alpha "Alpha: ", '12" screen'
\end{lstlisting}

would assign the value \code{'Alpha: 12" screen'} to \code{alpha}.
Similarly:

\begin{lstlisting}
%strcat beta '"foo"\', "'bar'"
\end{lstlisting}

would assign the value \code{`"foo" \textbackslash \textbackslash 'bar'`}
to \code{beta}.

The use of commas to separate strings is permitted but optional.

\subsection{\textindexlc{String Length}: \codeindex{\%strlen}}
\label{subsec:strlen}

The \code{\%strlen} operator assigns the length of a string to a macro.
For example:

\begin{lstlisting}
%strlen charcnt 'my string'
\end{lstlisting}

In this example, \code{charcnt} would receive the value 9, just as
if an \code{\%assign} had been used. In this example, \code{'my string'}
was a literal string but it could also have been a single-line
macro that expands to a string, as in the following example:

\begin{lstlisting}
%define sometext 'my string'
%strlen charcnt sometext
\end{lstlisting}

As in the first case, this would result in \code{charcnt} being
assigned the value of 9.

\subsection{\textindexlc{Extracting Substrings}: \codeindex{\%substr}}
\label{subsec:substr}

Individual letters or substrings in strings can be extracted using the
\code{\%substr} operator. An example of its use is probably more useful
than the description:

\begin{lstlisting}
%substr mychar 'xyzw' 1     ; equivalent to %define mychar 'x'
%substr mychar 'xyzw' 2     ; equivalent to %define mychar 'y'
%substr mychar 'xyzw' 3     ; equivalent to %define mychar 'z'
%substr mychar 'xyzw' 2,2   ; equivalent to %define mychar 'yz'
%substr mychar 'xyzw' 2,-1  ; equivalent to %define mychar 'yzw'
%substr mychar 'xyzw' 2,-2  ; equivalent to %define mychar 'yz'
\end{lstlisting}

As with \code{\%strlen} (see \fullref{subsec:strlen}), the first
parameter is the single-line macro to be created and the second
is the string. The third parameter specifies the first character
to be selected, and the optional fourth parameter (preceeded by comma)
is the length. Note that the first index is 1, not 0 and the last
index is equal to the value that \code{\%strlen} would assign given
the same string. Index values out of range result in an empty string.
A negative length means ``until N-1 characters before the end of string'',
i.e. \code{-1} means until end of string, \code{-2} until one character
before, etc.

\section{\textindexlc{Multi-Line Macros}: \indexcode{\%imacro}\codeindex{\%macro}}
\label{sec:mlmacro}

Multi-line macros are much more like the type of macro seen in MASM
and TASM: a multi-line macro definition in NASM looks something like
this.

\begin{lstlisting}
%macro  prologue 1

        push    ebp
        mov     ebp,esp
        sub     esp,%1

%endmacro
\end{lstlisting}

This defines a C-like function prologue as a macro: so you would
invoke the macro with a call such as

\begin{lstlisting}
myfunc:   prologue 12
\end{lstlisting}

which would expand to the three lines of code

\begin{lstlisting}
myfunc: push    ebp
        mov     ebp,esp
        sub     esp,12
\end{lstlisting}

The number \code{1} after the macro name in the \code{\%macro} line
defines the number of parameters the macro \code{prologue} expects
to receive. The use of \code{\%1} inside the macro definition refers
to the first parameter to the macro call. With a macro taking more
than one parameter, subsequent parameters would be referred to as
\code{\%2}, \code{\%3} and so on.

Multi-line macros, like single-line macros, are \textindex{case-sensitive},
unless you define them using the alternative directive \code{\%imacro}.

If you need to pass a comma as \emph{part} of a parameter to a
multi-line macro, you can do that by enclosing the entire parameter
in \index{braces, around macro parameters}braces. So you could code
things like

\begin{lstlisting}
%macro  silly 2

    %2: db      %1

%endmacro

        silly 'a', letter_a             ; letter_a:  db 'a'
        silly 'ab', string_ab           ; string_ab: db 'ab'
        silly {13,10}, crlf             ; crlf:      db 13,10
\end{lstlisting}

\subsection{Overloading Multi-Line Macros\index{overloading, multi-line macros}}
\label{subsec:mlmacover}

As with single-line macros, multi-line macros can be overloaded by
defining the same macro name several times with different numbers of
parameters. This time, no exception is made for macros with no
parameters at all. So you could define

\begin{lstlisting}
%macro  prologue 0

        push    ebp
        mov     ebp,esp

%endmacro
\end{lstlisting}

to define an alternative form of the function prologue which
allocates no local stack space.

Sometimes, however, you might want to ``overload'' a machine
instruction; for example, you might want to define

\begin{lstlisting}
%macro  push 2

        push    %1
        push    %2

%endmacro
\end{lstlisting}

so that you could code

\begin{lstlisting}
        push    ebx             ; this line is not a macro call
        push    eax,ecx         ; but this one is
\end{lstlisting}

Ordinarily, NASM will give a warning for the first of the above two
lines, since \code{push} is now defined to be a macro, and is being
invoked with a number of parameters for which no definition has been
given. The correct code will still be generated, but the assembler
will give a warning. This warning can be disabled by the use of the
\code{-w-macro-params} command-line option (see \fullref{subsec:opt-w}).

\subsection{\textindexlc{Macro-Local Labels}}
\label{subsec:maclocal}

NASM allows you to define labels within a multi-line macro definition
in such a way as to make them local to the macro call: so calling
the same macro multiple times will use a different label each time.
You do this by prefixing \codeindex{\%\%} to the label name.
So you can invent an instruction which executes a \code{RET} if the
\code{Z} flag is set by doing this:

\begin{lstlisting}
%macro  retz 0

        jnz     %%skip
        ret
    %%skip:

%endmacro
\end{lstlisting}

You can call this macro as many times as you want, and every time
you call it NASM will make up a different ``real'' name to substitute
for the label \code{\%\%skip}. The names NASM invents are of the form
\code{..@2345.skip}, where the number 2345 changes with every macro
call. The \codeindex{..@} prefix prevents macro-local labels from
interfering with the local label mechanism, as described in
\fullref{subsec:locallab}. You should avoid defining your own labels
in this form (the \code{..@} prefix, then a number, then another period)
in case they interfere with macro-local labels.

\subsection{\textindexlc{Greedy Macro Parameters}}
\label{subsec:mlmacgre}

Occasionally it is useful to define a macro which lumps its entire
command line into one parameter definition, possibly after
extracting one or two smaller parameters from the front. An example
might be a macro to write a text string to a file in MS-DOS, where
you might want to be able to write

\begin{lstlisting}
writefile [filehandle],"hello, world",13,10
\end{lstlisting}

NASM allows you to define the last parameter of a macro to be
\emph{greedy}, meaning that if you invoke the macro with more
parameters than it expects, all the spare parameters get lumped into
the last defined one along with the separating commas. So if you
code:

\begin{lstlisting}
%macro  writefile 2+

        jmp     %%endstr
  %%str:        db      %2
  %%endstr:
        mov     dx,%%str
        mov     cx,%%endstr-%%str
        mov     bx,%1
        mov     ah,0x40
        int     0x21

%endmacro
\end{lstlisting}

then the example call to \code{writefile} above will work as expected:
the text before the first comma, \code{[filehandle]}, is used as the
first macro parameter and expanded when \code{\%1} is referred to, and
all the subsequent text is lumped into \code{\%2} and placed after the
\code{db}.

The greedy nature of the macro is indicated to NASM by the use of
the \index{modifier, +}\code{+} sign after the parameter count on the
\code{\%macro} line.

If you define a greedy macro, you are effectively telling NASM how
it should expand the macro given \emph{any} number of parameters from
the actual number specified up to infinity; in this case, for
example, NASM now knows what to do when it sees a call to
\code{writefile} with 2, 3, 4 or more parameters. NASM will take this
into account when overloading macros, and will not allow you to
define another form of \code{writefile} taking 4 parameters (for
example).

Of course, the above macro could have been implemented as a
non-greedy macro, in which case the call to it would have had to
look like

\begin{lstlisting}
writefile [filehandle], {"hello, world",13,10}
\end{lstlisting}

NASM provides both mechanisms for putting \textindex{commas in macro
parameters}, and you choose which one you prefer for each macro
definition.

See \fullref{subsec:sectmac} for a better way to write the above macro.

\subsection{\textindexlc{Macro Parameters Range}}
\label{subsec:mlmacrange}

NASM allows you to expand parameters via special construction \code{\%\{x:y\}}
where \code{x} is the first parameter index and \code{y} is the last.
Any index can be either negative or positive but must never be zero.

For example

\begin{lstlisting}
%macro mpar 1-*
     db %{3:5}
%endmacro

mpar 1,2,3,4,5,6
\end{lstlisting}

expands to \code{3,4,5} range.

Even more, the parameters can be reversed so that

\begin{lstlisting}
%macro mpar 1-*
     db %{5:3}
%endmacro

mpar 1,2,3,4,5,6
\end{lstlisting}

expands to \code{5,4,3} range.

But even this is not the last. The parameters can be addressed via negative
indices so NASM will count them reversed. The ones who know Python may see
the analogue here.

\begin{lstlisting}
%macro mpar 1-*
     db %{-1:-3}
%endmacro

mpar 1,2,3,4,5,6
\end{lstlisting}

expands to \code{6,5,4} range.

Note that NASM uses \textindex{comma} to separate parameters being expanded.

By the way, here is a trick - you might use the index \code{\%{-1:-1}}
which gives you the \textindex{last} argument passed to a macro.

\subsection{\textindexlc{Default Macro Parameters}}
\label{subsec:mlmacdef}

NASM also allows you to define a multi-line macro with a \emph{range}
of allowable parameter counts. If you do this, you can specify
defaults for \textindex{omitted parameters}. So, for example:

\begin{lstlisting}
%macro  die 0-1 "Painful program death has occurred."

        writefile 2,%1
        mov     ax,0x4c01
        int     0x21

%endmacro
\end{lstlisting}

This macro (which makes use of the \code{writefile} macro defined in
\fullref{subsec:mlmacgre}) can be called with an explicit error message,
which it will display on the error output stream before exiting, or it can be
called with no parameters, in which case it will use the default
error message supplied in the macro definition.

In general, you supply a minimum and maximum number of parameters
for a macro of this type; the minimum number of parameters are then
required in the macro call, and then you provide defaults for the
optional ones. So if a macro definition began with the line

\begin{lstlisting}
%macro foobar 1-3 eax,[ebx+2]
\end{lstlisting}

then it could be called with between one and three parameters, and
\code{\%1} would always be taken from the macro call. \code{\%2}, if not
specified by the macro call, would default to \code{eax}, and \code{\%3}
if not specified would default to \code{[ebx+2]}.

You can provide extra information to a macro by providing
too many default parameters:

\begin{lstlisting}
%macro quux 1 something
\end{lstlisting}

This will trigger a warning by default; see \fullref{subsec:opt-w} for
more information.
When \code{quux} is invoked, it receives not one but two parameters.
\code{something} can be referred to as \code{\%2}. The difference
between passing \code{something} this way and writing \code{something}
in the macro body is that with this way \code{something} is evaluated
when the macro is defined, not when it is expanded.

You may omit parameter defaults from the macro definition, in which
case the parameter default is taken to be blank. This can be useful
for macros which can take a variable number of parameters, since the
\codeindex{\%0} token (see \fullref{subsec:percent0}) allows you to
determine how many parameters were really passed to the macro call.

This defaulting mechanism can be combined with the greedy-parameter
mechanism; so the \code{die} macro above could be made more powerful,
and more useful, by changing the first line of the definition to

\begin{lstlisting}
%macro die 0-1+ "Painful program death has occurred.",13,10
\end{lstlisting}

The maximum parameter count can be infinite, denoted by \code{*}. In
this case, of course, it is impossible to provide a \emph{full} set of
default parameters. Examples of this usage are shown in
\fullref{subsec:rotate}.

\subsection{\codeindex{\%0}: \index{counting macro parameters}Macro Parameter Counter}
\label{subsec:percent0}

The parameter reference \code{\%0} will return a numeric constant giving the
number of parameters received, that is, if \code{\%0} is n then \code{\%}n
is the last parameter. \code{\%0} is mostly useful for macros that can take a variable
number of parameters. It can be used as an argument to \code{\%rep}
(see \fullref{subsec:rep}) in order to iterate through all the parameters
of a macro. Examples are given in \fullref{subsec:rotate}.

\subsection{\codeindex{\%00}: \index{label preceeding macro}Label Preceeding Macro}
\label{subsec:percent00}

\code{\%00} will return the label preceeding the macro invocation, if any. The
label must be on the same line as the macro invocation, may be a local label
(see \fullref{locallab}), and need not end in a colon.

\subsection{\codeindex{\%rotate}: \textindex{Rotating Macro Parameters}}
\label{subsec:rotate}

Unix shell programmers will be familiar with the \index{shift
command}\code{shift} shell command, which allows the arguments passed
to a shell script (referenced as \code{\$1}, \code{\$2} and so on) to be
moved left by one place, so that the argument previously referenced
as \code{\$2} becomes available as \code{\$1}, and the argument previously
referenced as \code{\$1} is no longer available at all.

NASM provides a similar mechanism, in the form of \code{\%rotate}. As
its name suggests, it differs from the Unix \code{shift} in that no
parameters are lost: parameters rotated off the left end of the
argument list reappear on the right, and vice versa.

\code{\%rotate} is invoked with a single numeric argument (which may be
an expression). The macro parameters are rotated to the left by that
many places. If the argument to \code{\%rotate} is negative, the macro
parameters are rotated to the right.

\index{iterating over macro parameters}So a pair of macros to save and
restore a set of registers might work as follows:

\begin{lstlisting}
%macro  multipush 1-*

  %rep  %0
        push    %1
  %rotate 1
  %endrep

%endmacro
\end{lstlisting}

This macro invokes the \code{PUSH} instruction on each of its arguments
in turn, from left to right. It begins by pushing its first
argument, \code{\%1}, then invokes \code{\%rotate} to move all the arguments
one place to the left, so that the original second argument is now
available as \code{\%1}. Repeating this procedure as many times as there
were arguments (achieved by supplying \code{\%0} as the argument to
\code{\%rep}) causes each argument in turn to be pushed.

Note also the use of \code{*} as the maximum parameter count,
indicating that there is no upper limit on the number of parameters
you may supply to the \codeindex{multipush} macro.

It would be convenient, when using this macro, to have a \code{POP}
equivalent, which \emph{didn't} require the arguments to be given in
reverse order. Ideally, you would write the \code{multipush} macro
call, then cut-and-paste the line to where the pop needed to be
done, and change the name of the called macro to \code{multipop}, and
the macro would take care of popping the registers in the opposite
order from the one in which they were pushed.

This can be done by the following definition:

\begin{lstlisting}
%macro  multipop 1-*

  %rep %0
  %rotate -1
        pop     %1
  %endrep

%endmacro
\end{lstlisting}

This macro begins by rotating its arguments one place to the
\emph{right}, so that the original \emph{last} argument appears
as \code{\%1}. This is then popped, and the arguments are rotated
right again, socthe second-to-last argument becomes \code{\%1}.
Thus the arguments are iterated through in reverse order.

\subsection{\textindexlc{Concatenating Macro Parameters}}
\label{subsec:concat}

NASM can concatenate macro parameters and macro indirection constructs
on to other text surrounding them. This allows you to declare a family
of symbols, for example, in a macro definition. If, for example, you
wanted to generate a table of key codes along with offsets into the
table, you could code something like

\begin{lstlisting}
%macro keytab_entry 2

    keypos%1    equ     $-keytab
                db      %2

%endmacro

keytab:
          keytab_entry F1,128+1
          keytab_entry F2,128+2
          keytab_entry Return,13
\end{lstlisting}

which would expand to

\begin{lstlisting}
keytab:
keyposF1        equ     $-keytab
                db     128+1
keyposF2        equ     $-keytab
                db      128+2
keyposReturn    equ     $-keytab
                db      13
\end{lstlisting}

You can just as easily concatenate text on to the other end of a
macro parameter, by writing \code{\%1foo}.

If you need to append a \emph{digit} to a macro parameter, for example
defining labels \code{foo1} and \code{foo2} when passed the parameter
\code{foo}, you can't code \code{\%11} because that would be taken as the
eleventh macro parameter. Instead, you must code
\index{braces, after \% sign}\code{\%\{1\}1}, which will separate the first
\code{1} (giving the number of the macro parameter) from the second
(literal text to be concatenated to the parameter).

This concatenation can also be applied to other preprocessor in-line
objects, such as macro-local labels (\fullref{subsec:maclocal})
and context-local labels (\fullref{subsec:ctxlocal}).
In all cases, ambiguities in syntax can be resolved by enclosing
everything after the \code{\%} sign and before the literal text
in braces: so \code{\%\{\%foo\}bar} concatenates the text \code{bar}
to the end of the real name of the macro-local label \code{\%\%foo}.
(This is unnecessary, since the form NASM uses for the real names of
macro-local labels means that the two usages \code{\%\{\%foo\}bar}
and \code{\%\%foobar} would both expand to the same
thing anyway; nevertheless, the capability is there.)

The single-line macro indirection construct, \code{\%[...]}
(\fullref{subsec:indmacro}), behaves the same way as macro
parameters for the purpose of concatenation.

See also the \code{\%+} operator, \fullref{subsec:concatmacro}.

\subsection{\textindexlc{Condition Codes as Macro Parameters}}
\label{subsec:mlmaccc}

NASM can give special treatment to a macro parameter which contains
a condition code. For a start, you can refer to the macro parameter
\code{\%1} by means of the alternative syntax \codeindex{\%+1},
which informs NASM that this macro parameter is supposed to contain
a condition code, and will cause the preprocessor to report an
error message if the macro is called with a parameter which is
\emph{not} a valid condition code.

Far more usefully, though, you can refer to the macro parameter by
means of \codeindex{\%-1}, which NASM will expand as the \emph{inverse}
condition code. So the \code{retz} macro defined in \fullref{subsec:maclocal}
can be replaced by a general \textindexlc{conditional-return macro} like this:

\begin{lstlisting}
%macro  retc 1

        j%-1    %%skip
        ret
  %%skip:

%endmacro
\end{lstlisting}

This macro can now be invoked using calls like \code{retc ne}, which
will cause the conditional-jump instruction in the macro expansion
to come out as \code{JE}, or \code{retc po} which will make the jump a
\code{JPE}.

The \code{\%+1} macro-parameter reference is quite happy to interpret
the arguments \code{CXZ} and \code{ECXZ} as valid condition codes;
however, \code{\%-1} will report an error if passed either of these,
because no inverse condition code exists.

\subsection{\textindexlc{Disabling Listing Expansion}\indexcode{.nolist}}
\label{subsec:nolist}

When NASM is generating a listing file from your program, it will
generally expand multi-line macros by means of writing the macro
call and then listing each line of the expansion. This allows you to
see which instructions in the macro expansion are generating what
code; however, for some macros this clutters the listing up
unnecessarily.

NASM therefore provides the \code{.nolist} qualifier, which you can
include in a macro definition to inhibit the expansion of the macro
in the listing file. The \code{.nolist} qualifier comes directly after
the number of parameters, like this:

\begin{lstlisting}
%macro foo 1.nolist
\end{lstlisting}

Or like this:

\begin{lstlisting}
%macro bar 1-5+.nolist a,b,c,d,e,f,g,h
\end{lstlisting}

\subsection{Undefining Multi-Line Macros: \codeindex{\%unmacro}}
\label{subsec:unmacro}

Multi-line macros can be removed with the \code{\%unmacro} directive.
Unlike the \code{\%undef} directive, however, \code{\%unmacro} takes an
argument specification, and will only remove \textindex{exact matches} with
that argument specification.

For example:

\begin{lstlisting}
%macro foo 1-3
        ; Do something
%endmacro
%unmacro foo 1-3
\end{lstlisting}

removes the previously defined macro \code{foo}, but

\begin{lstlisting}
%macro bar 1-3
        ; Do something
%endmacro
%unmacro bar 1
\end{lstlisting}

does \emph{not} remove the macro \code{bar}, since the argument
specification does not match exactly.

\section{\textindexlc{Conditional Assembly}\indexcode{\%if}}
\label{sec:condasm}

Similarly to the C preprocessor, NASM allows sections of a source
file to be assembled only if certain conditions are met. The general
syntax of this feature looks like this:

\begin{lstlisting}
%if<condition>
    ; some code which only appears if <condition> is met
%elif<condition2>
    ; only appears if <condition> is not met but <condition2> is
%else
    ; this appears if neither <condition> nor <condition2> was met
%endif
\end{lstlisting}

The inverse forms \codeindex{\%ifn} and \codeindex{\%elifn} are also supported.

The \codeindex{\%else} clause is optional, as is the \codeindex{\%elif} clause.
You can have more than one \code{\%elif} clause as well.

There are a number of variants of the \code{\%if} directive.  Each has its
corresponding \code{\%elif}, \code{\%ifn}, and \code{\%elifn} directives; for
example, the equivalents to the \code{\%ifdef} directive are \code{\%elifdef},
\code{\%ifndef}, and \code{\%elifndef}.

\subsection{\codeindex{\%ifdef}: Testing Single-Line Macro Existence
\index{testing, single-line macro existence}}
\label{susbec:ifdef}

Beginning a conditional-assembly block with the line \code{\%ifdef MACRO}
will assemble the subsequent code if, and only if, a single-line macro called
\code{MACRO} is defined. If not, then the \code{\%elif} and \code{\%else}
blocks (if any) will be processed instead.

For example, when debugging a program, you might want to write code
such as

\begin{lstlisting}
          ; perform some function
%ifdef DEBUG
          writefile 2,"Function performed successfully",13,10
%endif
          ; go and do something else
\end{lstlisting}

Then you could use the command-line option \code{-dDEBUG} to create a
version of the program which produced debugging messages, and remove
the option to generate the final release version of the program.

You can test for a macro \emph{not} being defined by using
\codeindex{\%ifndef} instead of \code{\%ifdef}. You can also test
for macro definitions in \code{\%elif} blocks by using
\codeindex{\%elifdef} and \codeindex{\%elifndef}.

\subsection{\codeindex{\%ifmacro}: Testing Multi-Line Macro Existence
\index{testing, multi-line macro existence}}
\label{subsec:ifmacro}

The \code{\%ifmacro} directive operates in the same way as the \code{\%ifdef}
directive, except that it checks for the existence of a multi-line macro.

For example, you may be working with a large project and not have control
over the macros in a library. You may want to create a macro with one
name if it doesn't already exist, and another name if one with that name
does exist.

The \code{\%ifmacro} is considered true if defining a macro with the given name
and number of arguments would cause a definitions conflict. For example:

\begin{lstlisting}
%ifmacro MyMacro 1-3

     %error "MyMacro 1-3" causes a conflict with an existing macro.

%else

     %macro MyMacro 1-3

             ; insert code to define the macro

     %endmacro

%endif
\end{lstlisting}

This will create the macro ``\code{MyMacro 1-3}'' if no macro already exists which
would conflict with it, and emits a warning if there would be a definition
conflict.

You can test for the macro not existing by using the \codeindex{\%ifnmacro}
instead of \code{\%ifmacro}. Additional tests can be performed in
\code{\%elif} blocks by using \codeindex{\%elifmacro} and
\codeindex{\%elifnmacro}.

\subsection{\codeindex{\%ifctx}: Testing the Context Stack
\index{testing, context stack}}
\label{subsec:ifctx}

The conditional-assembly construct \code{\%ifctx} will cause the
subsequent code to be assembled if and only if the top context on
the preprocessor's context stack has the same name as one of the arguments.
As with \code{\%ifdef}, the inverse and \code{\%elif} forms \codeindex{\%ifnctx},
\codeindex{\%elifctx} and \codeindex{\%elifnctx} are also supported.

For more details of the context stack, see \fullref{sec:ctxstack}.
For a sample use of \code{\%ifctx}, see \fullref{sec:blockif}.

\subsection{\codeindex{\%if}: Testing Arbitrary Numeric Expressions}
\index{testing, arbitrary numeric expressions}
\label{subsec:if}

The conditional-assembly construct \code{\%if expr} will cause the
subsequent code to be assembled if and only if the value of the
numeric expression \code{expr} is non-zero. An example of the use of
this feature is in deciding when to break out of a \code{\%rep}
preprocessor loop: see \fullref{subsec:rep} for a detailed example.

The expression given to \code{\%if}, and its counterpart
\codeindex{\%elif}, is a critical expression (see \fullref{sec:crit}).

\code{\%if} extends the normal NASM expression syntax, by providing a
set of \textindexlc{relational operators} which are not normally available in
expressions. The operators \codeindex{=}, \codeindex{\textless},
\codeindex{\textgreater}, \codeindex{\textless=}, \codeindex{\textgreater=}
and \codeindex{\textless\textgreater} test equality,
less-than, greater-than, less-or-equal, greater-or-equal and not-equal
respectively. The C-like forms \codeindex{==} and \codeindex{!=} are
supported as alternative forms of \code{=} and \code{\textless\textgreater}.
In addition, low-priority logical operators \codeindex{\&\&},
\codeindex{\^{}\^{}} and \codeindex{||} are provided, supplying
\textindex{logical AND}, \textindex{logical XOR} and \textindex{logical OR}.
These work like the C logical operators (although C has no logical XOR),
in that they always return either 0 or 1, and treat any non-zero input as 1
(so that \code{\^{}\^{}}, for example, returns 1 if exactly one of its inputs
is zero, and 0 otherwise). The relational operators also return 1
for true and 0 for false.

Like other \code{\%if} constructs, \code{\%if} has a counterpart
\codeindex{\%elif}, and negative forms \codeindex{\%ifn} and \codeindex{\%elifn}.

\subsection{\codeindex{\%ifidn} and \codeindex{\%ifidni}: Testing Exact Text Identity}
\label{subsec:ifidn}
\index{testing, exact text identity}

The construct \code{\%ifidn text1,text2} will cause the subsequent code
to be assembled if and only if \code{text1} and \code{text2}, after
expanding single-line macros, are identical pieces of text.
Differences in white space are not counted.

\code{\%ifidni} is similar to \code{\%ifidn}, but is \textindex{case-insensitive}.

For example, the following macro pushes a register or number on the
stack, and allows you to treat \code{IP} as a real register:

\begin{lstlisting}
%macro  pushparam 1

  %ifidni %1,ip
        call    %%label
  %%label:
  %else
        push    %1
  %endif

%endmacro
\end{lstlisting}

Like other \code{\%if} constructs, \code{\%ifidn} has a counterpart
\codeindex{\%elifidn}, and negative forms \codeindex{\%ifnidn} and
\codeindex{\%elifnidn}. Similarly, \code{\%ifidni} has counterparts
\codeindex{\%elifidni}, \codeindex{\%ifnidni} and \codeindex{\%elifnidni}.

\label{subsec:iftyp}
\subsection{\codeindex{\%ifid}, \codeindex{\%ifnum}, \codeindex{\%ifstr}: Testing Token Types}
\index{testing, token types}

Some macros will want to perform different tasks depending on
whether they are passed a number, a string, or an identifier. For
example, a string output macro might want to be able to cope with
being passed either a string constant or a pointer to an existing
string.

The conditional assembly construct \code{\%ifid}, taking one parameter
(which may be blank), assembles the subsequent code if and only if
the first token in the parameter exists and is an identifier.
\code{\%ifnum} works similarly, but tests for the token being a numeric
constant; \code{\%ifstr} tests for it being a string.

For example, the \code{writefile} macro defined in \fullref{subsec:mlmacgre}
can be extended to take advantage of \code{\%ifstr} in the following fashion:

\begin{lstlisting}
%macro writefile 2-3+

  %ifstr %2
        jmp     %%endstr
    %if %0 = 3
      %%str:    db      %2,%3
    %else
      %%str:    db      %2
    %endif
      %%endstr: mov     dx,%%str
                mov     cx,%%endstr-%%str
  %else
                mov     dx,%2
                mov     cx,%3
  %endif
                mov     bx,%1
                mov     ah,0x40
                int     0x21

%endmacro
\end{lstlisting}

Then the \code{writefile} macro can cope with being called in either of
the following two ways:

\begin{lstlisting}
writefile [file], strpointer, length
writefile [file], "hello", 13, 10
\end{lstlisting}

In the first, \code{strpointer} is used as the address of an
already-declared string, and \code{length} is used as its length; in
the second, a string is given to the macro, which therefore declares
it itself and works out the address and length for itself.

Note the use of \code{\%if} inside the \code{\%ifstr}: this is to detect
whether the macro was passed two arguments (so the string would be a
single string constant, and \code{db \%2} would be adequate) or more (in
which case, all but the first two would be lumped together into
\code{\%3}, and \code{db \%2,\%3} would be required).

The usual \indexcode{\%elifid}\indexcode{\%elifnum}\indexcode{\%elifstr}\code{\%elif}...,
\indexcode{\%ifnid}\indexcode{\%ifnnum}\indexcode{\%ifnstr}\code{\%ifn}..., and
\indexcode{\%elifnid}\indexcode{\%elifnnum}\indexcode{\%elifnstr}\code{\%elifn}...
versions exist for each of \code{\%ifid}, \code{\%ifnum} and \code{\%ifstr}.

\subsection{\codeindex{\%iftoken}: Test for a Single Token}
\label{subsec:iftoken}

Some macros will want to do different things depending on if it is
passed a single token (e.g. paste it to something else using \code{\%+})
versus a multi-token sequence.

The conditional assembly construct \code{\%iftoken} assembles the
subsequent code if and only if the expanded parameters consist of
exactly one token, possibly surrounded by whitespace.

For example:

\begin{lstlisting}
%iftoken 1
\end{lstlisting}

will assemble the subsequent code, but

\begin{lstlisting}
%iftoken -1
\end{lstlisting}

will not, since \code{-1} contains two tokens: the unary minus operator
\code{-}, and the number \code{1}.

The usual \codeindex{\%eliftoken}, \codeindex{\%ifntoken}, and
\codeindex{\%elifntoken} variants are also provided.

\subsection{\codeindex{\%ifempty}: Test for Empty Expansion}
\label{subsec:ifempty}

The conditional assembly construct \code{\%ifempty} assembles the
subsequent code if and only if the expanded parameters do not contain
any tokens at all, whitespace excepted.

The usual \codeindex{\%elifempty}, \codeindex{\%ifnempty}, and
\codeindex{\%elifnempty} variants are also provided.

\label{subsec:ifenv}
\subsection{\codeindex{\%ifenv}: Test If Environment Variable Exists}

The conditional assembly construct \code{\%ifenv} assembles the
subsequent code if and only if the environment variable referenced by
the \code{\%!}\emph{variable} directive exists.

The usual \codeindex{\%elifenv}, codeindex{\%ifnenv}, and \codeindex{\%elifnenv}
variants are also provided.

Just as for \code{\%!}\emph{variable} the argument should be written as a
string if it contains characters that would not be legal in an
identifier. See \fullref{subsec:getenv}.

\section{\textindexlc{Preprocessor Loops}\index{repeating code}: \codeindex{\%rep}}
\label{sec:rep}

NASM's \code{TIMES} prefix, though useful, cannot be used to invoke a
multi-line macro multiple times, because it is processed by NASM
after macros have already been expanded. Therefore NASM provides
another form of loop, this time at the preprocessor level: \code{\%rep}.

The directives \code{\%rep} and \codeindex{\%endrep} (\code{\%rep}
takes a numeric argument, which can be an expression; \code{\%endrep}
takes no arguments) can be used to enclose a chunk of code, which is then
replicated as many times as specified by the preprocessor:

\begin{lstlisting}
%assign i 0
%rep    64
        inc     word [table+2*i]
%assign i i+1
%endrep
\end{lstlisting}

This will generate a sequence of 64 \code{INC} instructions,
incrementing every word of memory from \code{[table]} to
\code{[table+126]}.

For more complex termination conditions, or to break out of a repeat
loop part way along, you can use the \codeindex{\%exitrep} directive to
terminate the loop, like this:

\begin{lstlisting}
fibonacci:
%assign i 0
%assign j 1
%rep 100
%if j > 65535
        %exitrep
%endif
        dw j
%assign k j+i
%assign i j
%assign j k
%endrep

fib_number equ ($-fibonacci)/2
\end{lstlisting}

This produces a list of all the Fibonacci numbers that will fit in
16 bits. Note that a maximum repeat count must still be given to
\code{\%rep}. This is to prevent the possibility of NASM getting into an
infinite loop in the preprocessor, which (on multitasking or
multi-user systems) would typically cause all the system memory to
be gradually used up and other applications to start crashing.

Note a maximum repeat count is limited by 62 bit number, though it
is hardly possible that you ever need anything bigger.
